---
title: "R Graphics with ggplot2"
subtitle: "ggmap and the Google Maps Static API"
author: "Evan Muzzall"
date: "November 4, 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Package installation 

```{r eval = FALSE}
install.packages("ggmap")

library(ggplot2)
library(cowplot)
library(dplyr)
library(ggmap)
```

# Challenge

### 1. Create six graphs

Load the [ggplot2 cheatsheet](https://rstudio.com/wp-content/uploads/2019/01/Cheatsheets_2019.pdf) and the [iris dataset](https://en.wikipedia.org/wiki/Iris_flower_data_set) to create six visualizations and combine them into a single figure. 

Note the code for custom colors. 

```{r}
data(iris)
```

```{r}
library(ggplot2)
## CODE FOR PLOT 1 HERE
```

```{r}
library(ggplot2)
## CODE FOR PLOT 2 HERE
```

```{r}
library(ggplot2)
## CODE FOR PLOT 3 HERE
```

```{r}
library(ggplot2)
## CODE FOR PLOT 4 HERE
```

```{r}
library(ggplot2)
## CODE FOR PLOT 5 HERE
```

```{r}
library(ggplot2)
## CODE FOR PLOT 6 HERE
```

```{r}
## CODE FOR COMPOUND FIGURE HERE

## CODE TO SAVE FIGURE HERE
```

### 2. Maps!

##### The data

For this mapping example, we will use the first 1000 rows from the Obervation.org nature dataset from the Netherlands housed at the [Global Biodiversity Information Facility (GBIF)](https://www.gbif.org/occurrence/download?dataset_key=8a863029-f435-446a-821e-275f4f641165) (login required; [citation](https://doi.org/10.15468/dl.jgjalb), [citation guidelines](https://www.gbif.org/citation-guidelines), [data user agreement](https://www.gbif.org/terms/data-user). 

```{r}
gbif = read.csv("data/gbif_1000.csv", stringsAsFactors = TRUE, 
                sep = "\t")
head(gbif)
```

##### Connecting to the Google Maps Static API

If you want to add your data to Google Maps, you must first 1) enable the Maps Static API and 2) enable billing by entering your credit card information. Don't worry though, Google gives you a bunch of free credits and will not charge you without your permission. 

1. Visit https://cloud.google.com/

2. Click "Go to console"

3. Login with a gmail account and click "Create Project" and enter your information

4. Click the hamburger and then "APIs and Services"

5. Click "+ Enable APIs and Services" and search for "Maps Static API", then click "Enable"

6. Click the hamburger and then "APIs and Services"

7. Click "Credentials" then "Create Credentials" then "API key"

8. You should see a popup window that says "API key created" - click "Restrict key", then select "Restrict key", click the dropdown menu and select "Maps Static API" and then save

9. In the searchbar, type "billing" and select "Billing", click "Manage Billing Accounts" and then "Add Billing Account". Enter your information and select "Save and enable billing"

10. Copy your API key into the below code: 

```{r eval = FALSE}
ggmap::register_google(key = "YOUR API KEY HERE") 
```

```{r}
# choose the lat/lon from the first row in the gbif dataset as the center point
# you might want to find something more central! 
netherlands = ggmap(get_googlemap(center = c(lon = 5.55, lat = 52.00),
                                  zoom = 7, scale = 2,
                                  maptype = "terrain",
                                  color = "color"))

netherlands

ggsave(filename = "visuals/netherlands.pdf", plot = netherlands, 
       width = 12, height = 8, units = "in", dpi = 600)
```

> If this does not work, you might need the GitHub version of ggmap
```
devtools::install_github("dkahle/ggmap")
library(ggmap)
```

Now, we can plot the rest of the data on the Google Map

```{r}
gbif_center_point = c(lon = 5.55, lat = 52.00)

gbif_map = get_map(gbif_center_point, zoom = 7) 

# Country overlay
netherlands_data = ggmap(gbif_map) + 
  geom_point(data = gbif, alpha = 0.5, 
             aes(x = decimalLongitude, y = decimalLatitude, 
                 col = kingdom)) 

netherlands_data

ggsave(filename = "visuals/netherlands_data.pdf", plot = netherlands_data, 
       width = 12, height = 8, units = "in", dpi = 600)

# Facet by province
netherlands_facet = ggmap(gbif_map) + 
  geom_point(data = gbif, alpha = 0.5, 
             aes(x = decimalLongitude, y = decimalLatitude, 
                 col = kingdom)) + 
  ggtitle("Observation variation by Netherlands province") + 
  facet_wrap(~stateProvince)

netherlands_facet

ggsave(filename = "visuals/netherlands_facet.pdf", plot = netherlands_facet, 
       width = 12, height = 8, units = "in", dpi = 600)
```

Be sure to click "Shut Down" on your Google Cloud project when you are done so that it does not run in perpetuity :) 
